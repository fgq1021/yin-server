import{d as v,N as B,e as $,f as w,g as F,u as A,_ as I,r,o as i,c as p,a as m,w as u,F as T,h as a,i as l,b as d,t as D,j as b,p as E,k as N}from"./index-8d1328d9.js";import{N as q,a as U,b as S}from"./Tabs-7208b5b4.js";const P=v({name:"AuthView",components:{NCard:B,NTabs:q,NTabPane:U,NButton:$,NFormItemRow:S,NInput:w,NInputGroup:F},setup(){return{message:A()}},data(){return{_tel:"",code:"",_password:"",confirmPassword:"",device:"",msg:"",time:60,backTo:null,register:!1}},methods:{getCode(){this.$yin.User.auth.code.get(this._tel).then(e=>{this.device=e.device,this.time=60;let t=setInterval(()=>{this.time?this.time--:clearInterval(t)},1e3)}).catch(e=>{this.msg=e.message})},auth(){this.$yin.User.auth.code.auth(this).then(e=>{if(this.message.success({title:(e._title||e._tel)+" 登录成功",duration:2e3}),this.$route.name==="auth")if(this.$route.query.code){const t=this.$route.query.state;t?(this.backTo=localStorage.getItem(t),localStorage.removeItem(t),this.back()):(this.backTo="/",this.back())}else this.$route.query.url?(this.backTo=this.$route.query.url,this.back()):this.back();else this.$emit("close")}).catch(e=>{this.msg=e.response.data.msg||e.message})},authWX(){if(this.isWX&&!this._store.state.user.wx.openid&&!this.$route.query.code){let e=this.$route.query.url,t;e&&(t="authBackUrl"+new Date().getTime(),localStorage.setItem(t,e)),this.$yin.User.auth.wx.auth(t||"")}else this.$route.query.code&&this.$yin.User.auth.wx.getUserInfo(this.$route.query.code).then(()=>{const e=this.$route.query.state;e?(this.backTo=localStorage.getItem(e),localStorage.removeItem(e),this.back()):(this.backTo="/",this.back())}).catch(e=>this.userInfo=e)},async reg(){var e,t;try{const s=await this.$yin.User.register(this._tel,this._password);this.message.success({title:(s._title||s._tel)+" 注册成功",duration:2e3}),this.$route.query.url?(this.backTo=this.$route.query.url,this.back()):this.back()}catch(s){this.msg=((t=(e=s==null?void 0:s.response)==null?void 0:e.data)==null?void 0:t.msg)||(s==null?void 0:s.message)}},async authPassword(){var e,t;try{const s=await this.$yin.User.authPassword(this._tel,this._password);this.message.success({title:(s._title||s._tel)+" 登录成功",duration:2e3}),this.$route.query.url?(this.backTo=this.$route.query.url,this.back()):this.back()}catch(s){this.msg=((t=(e=s==null?void 0:s.response)==null?void 0:e.data)==null?void 0:t.msg)||(s==null?void 0:s.message)}},back(){console.log(this.backTo),this.backTo?this.$router.push(this.backTo):this.$router.go(-1)}},mounted(){this.authWX(),this.$yin.me._id?this.back():this.$yin.me._token&&this.back(),this.$yin.system.uninitialized&&(this.register=!0)}});const k=e=>(E("data-v-8b00193f"),e=e(),N(),e),V={class:"auth"},z={key:0,class:"authing"},W=k(()=>b("p",null,"此时注册的用户将为管理员",-1)),X={key:1,class:"btn raw"},j={key:2,class:"btn raw"},G=k(()=>b("p",{class:"title"},"输入手机号自动登录/注册",-1)),R={class:"btn raw"};function H(e,t,s,J,K,L){const y=r("n-h4"),c=r("n-input"),h=r("n-form-item-row"),n=r("n-button"),f=r("n-tab-pane"),_=r("n-input-group"),g=r("n-tabs"),C=r("n-card");return i(),p("div",V,[e.$yin.me._token&&!e.$yin.me._id?(i(),p("div",z," 受权中... ")):(i(),m(C,{key:1,title:"引.object - 对象操作台",class:"table"},{default:u(()=>[e.$yin.system.uninitialized?(i(),p(T,{key:0},[a(y,null,{default:u(()=>[l("初始化")]),_:1}),W],64)):d("",!0),a(g,{"default-value":"password",size:"large"},{default:u(()=>[a(f,{name:"password",tab:"密码"},{default:u(()=>[a(h,{label:"手机号"},{default:u(()=>[a(c,{value:e._tel,"onUpdate:value":t[0]||(t[0]=o=>e._tel=o),type:"tel",placeholder:"请输入手机号"},null,8,["value"])]),_:1}),a(h,{label:"密码",feedback:e.msg},{default:u(()=>[a(c,{value:e._password,"onUpdate:value":t[1]||(t[1]=o=>e._password=o),type:"password",center:"",clearable:"",placeholder:"请输入密码"},null,8,["value"])]),_:1},8,["feedback"]),e.register?(i(),m(h,{key:0,label:"确认密码"},{default:u(()=>[a(c,{value:e.confirmPassword,"onUpdate:value":t[2]||(t[2]=o=>e.confirmPassword=o),type:"password",center:"",clearable:"",placeholder:"再次输入密码"},null,8,["value"])]),_:1})):d("",!0),e.register?d("",!0):(i(),p("div",X,[a(n,{onClick:e.authPassword,block:"",type:"primary"},{default:u(()=>[l("登录")]),_:1},8,["onClick"]),a(n,{onClick:t[3]||(t[3]=o=>e.register=!0),block:"",type:"default"},{default:u(()=>[l("注册")]),_:1})])),e.register?(i(),p("div",j,[a(n,{onClick:t[4]||(t[4]=o=>e.register=!1),block:"",type:"default"},{default:u(()=>[l("登录")]),_:1}),a(n,{onClick:e.reg,block:"",type:"primary"},{default:u(()=>[l("注册")]),_:1},8,["onClick"])])):d("",!0)]),_:1}),a(f,{name:"code",tab:"验证码"},{default:u(()=>[G,a(h,{label:"手机号"},{default:u(()=>[a(c,{value:e._tel,"onUpdate:value":t[5]||(t[5]=o=>e._tel=o),type:"tel",placeholder:"请输入手机号"},null,8,["value"])]),_:1}),a(h,{label:"短信验证码",feedback:e.msg},{default:u(()=>[a(_,null,{default:u(()=>[a(c,{value:e.code,"onUpdate:value":t[6]||(t[6]=o=>e.code=o),center:"",clearable:"",placeholder:"请输入短信验证码",autocomplete:"one-time-code"},null,8,["value"]),e.device?d("",!0):(i(),m(n,{key:0,disabled:e._tel==="",type:"primary",onClick:e.getCode},{default:u(()=>[l(" 发送验证码 ")]),_:1},8,["disabled","onClick"])),e.device&&e.time>0?(i(),m(n,{key:1,disabled:!0,type:"primary"},{default:u(()=>[l(" 已发送("+D(e.time)+") ",1)]),_:1})):d("",!0),e.device&&e.time===0?(i(),m(n,{key:2,type:"primary",onClick:e.getCode},{default:u(()=>[l(" 再次发送 ")]),_:1},8,["onClick"])):d("",!0)]),_:1})]),_:1},8,["feedback"]),b("div",R,[a(n,{type:"primary",block:"",onClick:e.auth},{default:u(()=>[l("登录/注册")]),_:1},8,["onClick"])])]),_:1})]),_:1})]),_:1}))])}const Q=I(P,[["render",H],["__scopeId","data-v-8b00193f"]]);export{Q as default};
//# sourceMappingURL=AuthView-b1ed8e4b.js.map
