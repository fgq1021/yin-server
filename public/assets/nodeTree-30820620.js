var Q=Object.defineProperty;var X=(e,t,n)=>t in e?Q(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var P=(e,t,n)=>(X(e,typeof t!="symbol"?t+"":t,n),n);import{d as L,o as a,c as d,g as F,_ as T,x as R,y as b,P as $,r as w,a as E,j as Y,w as r,f as h,t as k,b as j,e as v,F as N,i as W,v as B,q as z,s as S,k as H}from"./index-f616c1b3.js";import{Y as I}from"./yinMenuItem-3bd0f4bf.js";const Z={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 24 24"},x=F("path",{d:"M13 7h-2v4H7v2h4v4h2v-4h4v-2h-4V7zm-1-5C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8s8 3.59 8 8s-3.59 8-8 8z",fill:"currentColor"},null,-1),ee=[x],te=L({name:"AddCircleOutlineFilled",render:function(t,n){return a(),d("svg",Z,ee)}}),ne={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 24 24"},se=F("path",{d:"M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z",fill:"currentColor"},null,-1),oe=[se],q=L({name:"ContentCopyFilled",render:function(t,n){return a(),d("svg",ne,oe)}}),ie={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 24 24"},re=F("path",{d:"M18 2H9c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h9c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H9V4h9v12zM3 15v-2h2v2H3zm0-5.5h2v2H3v-2zM10 20h2v2h-2v-2zm-7-1.5v-2h2v2H3zM5 22c-1.1 0-2-.9-2-2h2v2zm3.5 0h-2v-2h2v2zm5 0v-2h2c0 1.1-.9 2-2 2zM5 6v2H3c0-1.1.9-2 2-2z",fill:"currentColor"},null,-1),le=[re],K=L({name:"CopyAllFilled",render:function(t,n){return a(),d("svg",ie,le)}}),ue={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 24 24"},ae=F("path",{d:"M4 13h6c.55 0 1-.45 1-1V4c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v8c0 .55.45 1 1 1zm0 8h6c.55 0 1-.45 1-1v-4c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v4c0 .55.45 1 1 1zm10 0h6c.55 0 1-.45 1-1v-8c0-.55-.45-1-1-1h-6c-.55 0-1 .45-1 1v8c0 .55.45 1 1 1zM13 4v4c0 .55.45 1 1 1h6c.55 0 1-.45 1-1V4c0-.55-.45-1-1-1h-6c-.55 0-1 .45-1 1z",fill:"currentColor"},null,-1),ce=[ae],U=L({name:"DashboardRound",render:function(t,n){return a(),d("svg",ue,ce)}}),he={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 24 24"},de=F("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM8 9h8v10H8V9zm7.5-5l-1-1h-5l-1 1H5v2h14V4z",fill:"currentColor"},null,-1),pe=[de],G=L({name:"DeleteOutlineFilled",render:function(t,n){return a(),d("svg",he,pe)}}),fe={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 24 24"},me=F("path",{d:"M9.41 15.59L8 17l-4-4l4-4l1.41 1.41L7.83 12c1.51-.33 3.73.08 5.17 1.36V6.83l-1.59 1.59L10 7l4-4l4 4l-1.41 1.41L15 6.83V21h-2v-4c-.73-2.58-3.07-3.47-5.17-3l1.58 1.59z",fill:"currentColor"},null,-1),ve=[me],J=L({name:"ForkLeftFilled",render:function(t,n){return a(),d("svg",fe,ve)}}),ye={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 24 24"},ge=F("path",{d:"M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z",fill:"currentColor"},null,-1),we=[ge],Fe=L({name:"FullscreenExitFilled",render:function(t,n){return a(),d("svg",ye,we)}}),ke={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 24 24"},be=F("path",{d:"M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z",fill:"currentColor"},null,-1),Ce=[be],Ee=L({name:"FullscreenFilled",render:function(t,n){return a(),d("svg",ke,Ce)}}),_e={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 24 24"},Me=F("path",{d:"M11 21h2V6.83l1.59 1.59L16 7l-4-4l-4 4l1.41 1.41L11 6.83V9c0 4.27-4.03 7.13-6 8.27l1.46 1.46C8.37 17.56 9.9 16.19 11 14.7V21z",fill:"currentColor"},null,-1),Le=[Me],$e=L({name:"RampRightFilled",render:function(t,n){return a(),d("svg",_e,Le)}});const je={},De={class:"nodeMenu"},Be={class:"targetBox"},Pe={class:"itemList"};function Ae(e,t){return a(),d("div",De,[F("div",Be,[R(e.$slots,"target")]),F("div",Pe,[R(e.$slots,"default")])])}const V=T(je,[["render",Ae]]),ze=L({name:"yinMenuObject",components:{ForkLeftFilled:J,YinMenuItem:I,YinMenu:V,DeleteOutlineFilled:G,CopyAllFilled:K,ContentCopyFilled:q,DashboardRound:U},props:["screen","objectList","right"],data(){return{object:{},parent:null,key:null,objectNode:null,inArray:!0}},methods:{async init(){this.object=await b.get(this.screen.menu.target);const e=this.objectList[this.screen.menu.target];this.objectNode=e,e&&(this.parent=await b.get(e.parent),this.key=this.parent._schemaMix[e.parent.key],this.inArray=this.key.type==="Array")},putEvent(e){this.screen.events[this.screen.menu.target]=e},putEvents(e){for(let t of this.screen.target)this.screen.events[t]=e},async putParentsEvents(e){for(let t of this.screen.target){const n=this.objectList[t];for(let s in n.parents)this.screen.events[s]=e}},samePlace(){var t;const e=[];for(let n of this.screen.target){const s=this.objectList[n];s&&((t=s.parent)==null?void 0:t.valueOf())===this.screen.targetPlace&&e.push(n)}return e},putEventsAtSamePlace(e){const t=this.samePlace();for(let n of t)this.screen.events[n]=e},putPlaceEvent(e){this.screen.events[this.objectNode.parent]=e},async putPlaceEvents(e){if(this.objectNode)for(let t in this.objectNode.parents||{})this.screen.events[t]=e;else for(let t of this.object._parents)this.screen.events[new $(this.object._name,t)]=e},removeEvent(){this.screen.events={}},async remove(){for(let e of this.screen.target)await(await b.get(e))._delete();delete this.screen.menu,this.removeEvent()},reference(){this.screen.refs=this.screen.target,delete this.screen.menu,this.removeEvent()},async exportObject(){const e=this.samePlace();for(let t of e)await this.parent[this.key.name].remove(t);this.reference()},async makeCopy(){const e=this.samePlace();for(let t of e)try{await this.parent[this.key.name].create(await b.get(t))}catch{}},dashboard(){window.open(`/#/dashboard/${this.screen.menu.target}`),delete this.screen.menu}},watch:{"screen.menu.target":"init"},mounted(){this.init()}}),Te={class:"main"},Oe={style:{"font-size":"smaller"}},Se={key:0},He={key:0},Ne={key:1};function Ve(e,t,n,s,u,o){const l=w("DeleteOutlineFilled"),i=w("yin-menu-item"),c=w("CopyAllFilled"),m=w("ForkLeftFilled"),C=w("ContentCopyFilled"),D=w("DashboardRound"),p=w("yin-menu");return a(),E(p,null,Y({default:r(()=>[v(i,{onMouseover:t[0]||(t[0]=_=>{e.putEvents("delete"),e.putParentsEvents("delete")}),onMouseout:e.removeEvent,onClick:e.remove},{icon:r(()=>[v(l)]),default:r(()=>[h(" 删除 ")]),_:1},8,["onMouseout","onClick"]),v(i,{onMouseover:t[1]||(t[1]=_=>e.putEvents("ref")),onMouseout:e.removeEvent,onClick:e.reference},{icon:r(()=>[v(c)]),info:r(()=>[h(" 对象只是被引用到不同的位置 ")]),default:r(()=>[h(" 引用（复制） ")]),_:1},8,["onMouseout","onClick"]),e.inArray?(a(),E(i,{key:0,onMouseover:t[2]||(t[2]=_=>{e.putEventsAtSamePlace("update"),e.putPlaceEvent("update")}),onMouseout:e.removeEvent,onClick:e.exportObject},{icon:r(()=>[v(m)]),info:r(()=>[h("对象|位置 只是不再被引入到该位置")]),default:r(()=>[h(" 引出（剪切） ")]),_:1},8,["onMouseout","onClick"])):(a(),E(i,{key:1,onMouseover:t[3]||(t[3]=_=>{e.putEvent("ref"),e.putPlaceEvent("update")}),onMouseout:e.removeEvent,onClick:e.exportObject},{icon:r(()=>[v(m)]),info:r(()=>[h("对象|位置 只是不再被引入到该位置")]),default:r(()=>[h(" 引出（剪切） ")]),_:1},8,["onMouseout","onClick"])),v(i,{onMouseover:t[4]||(t[4]=_=>{e.putEventsAtSamePlace("read"),e.putPlaceEvent("update")}),onMouseout:e.removeEvent,onClick:e.makeCopy},{icon:r(()=>[v(C)]),info:r(()=>[e.inArray?(a(),d("span",He,"为当前位置中被选中的对象创建副本")):(a(),d("span",Ne,"*在当前位置创建副本以替换该对象"))]),default:r(()=>[h(" 创建副本 ")]),_:1},8,["onMouseout","onClick"]),v(i,{onMouseover:t[5]||(t[5]=_=>e.putEvent("default")),onMouseout:e.removeEvent,onClick:e.dashboard},{icon:r(()=>[v(D)]),info:r(()=>[h("可分享给他人查看或编辑（须登录）")]),default:r(()=>[h(" 控制面板 ")]),_:1},8,["onMouseout","onClick"])]),_:2},[e.object._id?{name:"target",fn:r(()=>[F("p",Te,[h(k(e.object._title)+" ",1),F("span",Oe,": "+k(e.object._module.title),1)]),e.screen.target.length>1?(a(),d("p",Se,"... 等 "+k(e.screen.target.length)+"个对象",1)):j("",!0)]),key:"0"}:void 0]),1024)}const Re=T(ze,[["render",Ve]]),Ye=L({name:"yinMenuStructure",components:{YinMenuItem:I,YinMenu:V,DeleteOutlineFilled:G,CopyAllFilled:K,ContentCopyFilled:q,DashboardRound:U,ForkLeftFilled:J,RampRightFilled:$e,AddCircleOutlineFilled:te},props:["screen","objectList","right"],data(){return{parent:{},key:{},value:null,models:[]}},computed:{hasObject(){return b.structureType.indexOf(this.key.type)!==-1&&this.key.type!=="Array"&&this.value},hasRefs(){var e;return(e=this.screen.refs)==null?void 0:e.length}},methods:{async init(){const e=new $(this.screen.menu.target);if(this.parent=await b.get(this.screen.menu.target),this.key=this.parent._schemaMix[e.key],b.structureType.indexOf(this.key.type)!==-1){try{this.value=await this.parent[e.key]}catch{this.value=null}this.models=await this.parent[e.key].models()}},moduleTitle(e=this.key){var t;return["Object","Array"].includes(e.type)?this.parent._module.title:((t=b[e.type])==null?void 0:t.title)||e.type},putEvent(e){this.screen.events[this.screen.menu.target]=e},putChildEvent(e){this.screen.events[this.value._place.valueOf()]=e},putChildrenEvents(e){},removeEvent(){this.screen.events={}},async removeChild(){await this.value._delete(),delete this.screen.menu,this.removeEvent()},referenceChild(){this.screen.refs=[this.value._place.valueOf()],delete this.screen.menu,this.removeEvent()},reference(){},async importObject(){if(this.key.type==="Array")for(let e of this.screen.refs)await this.parent[this.key.name].push(e);else this.parent[this.key.name]=this.screen.refs[0],await this.parent._save();delete this.screen.menu,this.removeEvent()},importHover(){if(this.putEvent("update"),this.key.type==="Array")for(let e of this.screen.refs)this.screen.events[e]="read";else this.screen.events[this.screen.refs[0]]="read"},async importCopyObject(){if(this.key.type==="Array")for(let e of this.screen.refs)await this.parent[this.key.name].create(await b.get(e));else await this.parent[this.key.name].create(await b.get(this.screen.refs[0]));delete this.screen.menu,this.removeEvent()},async exportObject(){await this.parent[this.key.name].remove(this.value._id),this.screen.refs=[this.value._place.valueOf()],delete this.screen.menu,this.removeEvent()},async createObject(e){e?await this.parent[this.key.name].create({_model:e._id}):await this.parent[this.key.name].create(),delete this.screen.menu,this.removeEvent()},dashboard(){window.open(`/#/dashboard/${this.screen.menu.target}`),delete this.screen.menu}},watch:{"screen.menu.target":"init"},mounted(){this.init()}}),We={class:"main"},Ie={style:{"font-size":"smaller"}},qe={key:0},Ke={key:1},Ue={key:2},Ge=F("hr",null,null,-1),Je={key:0},Qe={key:1},Xe={key:0},Ze={key:1},xe={key:2};function et(e,t,n,s,u,o){const l=w("DeleteOutlineFilled"),i=w("yin-menu-item"),c=w("CopyAllFilled"),m=w("RampRightFilled"),C=w("ContentCopyFilled"),D=w("ForkLeftFilled"),p=w("AddCircleOutlineFilled"),_=w("yin-menu");return a(),E(_,null,{target:r(()=>{var y,M;return[F("p",We,[h(k(e.parent._title)+"."+k(e.key.title)+" ",1),F("span",Ie,": "+k(e.moduleTitle(e.key)),1)]),e.key.type==="Array"?(a(),d("p",qe," 共"+k((M=(y=e.value)==null?void 0:y.option)==null?void 0:M.total)+"个对象 ",1)):e.hasObject?(a(),d("p",Ke,k(e.value._title),1)):(a(),d("p",Ue," 未创建 "))]}),default:r(()=>[e.hasObject?(a(),d(N,{key:0},[v(i,{onMouseover:t[0]||(t[0]=y=>{e.putEvent("delete"),e.putChildEvent("delete")}),onMouseout:e.removeEvent,onClick:e.removeChild},{icon:r(()=>[v(l)]),info:r(()=>[h("删除该位置的对象")]),default:r(()=>[h(" 删除 "+k(e.value._title||e.value._place)+" ",1)]),_:1},8,["onMouseout","onClick"]),v(i,{onMouseover:t[1]||(t[1]=y=>e.putChildEvent("ref")),onMouseout:e.removeEvent,onClick:e.referenceChild},{icon:r(()=>[v(c)]),info:r(()=>[h("引用该位置的对象")]),default:r(()=>[h(" 引用 "+k(e.value._title||e.value._place)+" ",1)]),_:1},8,["onMouseout","onClick"]),Ge],64)):j("",!0),v(i,{onMouseover:t[2]||(t[2]=y=>e.putEvent("ref")),onMouseout:e.removeEvent,onClick:e.reference},{icon:r(()=>[v(c)]),info:r(()=>[h("引用该位置")]),mate:r(()=>[h("开发中*")]),default:r(()=>[h(" 引用（复制） ")]),_:1},8,["onMouseout","onClick"]),e.hasRefs?(a(),E(i,{key:1,onMouseover:e.importHover,onMouseout:e.removeEvent,onClick:e.importObject},{icon:r(()=>[v(m)]),info:r(()=>[h("对象|位置 只是被引入到该位置,非复制")]),default:r(()=>[h(" 引入（粘贴* | 映射 | 挂载） ")]),_:1},8,["onMouseover","onMouseout","onClick"])):j("",!0),e.hasRefs?(a(),E(i,{key:2,onMouseover:e.importHover,onMouseout:e.removeEvent,onClick:e.importCopyObject},{icon:r(()=>[v(C)]),info:r(()=>[h("在该位置创建引用对象的副本")]),default:r(()=>[h(" 引入副本 ")]),_:1},8,["onMouseover","onMouseout","onClick"])):j("",!0),e.hasObject?(a(),E(i,{key:3,onMouseover:t[3]||(t[3]=y=>{e.putEvent("update"),e.putChildEvent("ref")}),onMouseout:e.removeEvent,onClick:e.exportObject},{icon:r(()=>[v(D)]),info:r(()=>[h("对象|位置 只是不再被引入到该位置")]),default:r(()=>[h(" 引出（剪切） ")]),_:1},8,["onMouseout","onClick"])):j("",!0),v(i,{onMouseover:t[4]||(t[4]=y=>e.putEvent("update")),onMouseout:e.removeEvent,onClick:t[5]||(t[5]=y=>e.createObject())},Y({icon:r(()=>[v(p)]),default:r(()=>[e.hasObject?(a(),d("span",Je,"重新创建")):(a(),d("span",Qe,"新建"))]),_:2},[e.hasObject?{name:"info",fn:r(()=>[h("顶替现有对象 "+k(e.value._title||e.value._place),1)]),key:"0"}:void 0,e.parent._id?{name:"mate",fn:r(()=>[e.models.length>1?(a(),d("span",Xe," > ")):e.models.length===1?(a(),d("span",Ze,k(e.models[0]._title)+":"+k(e.moduleTitle(e.key)),1)):(a(),d("span",xe,"无模型"+k(e.parent._module.title),1))]),key:"1"}:void 0,e.models.length>1?{name:"children",fn:r(()=>[(a(!0),d(N,null,W(e.models,y=>(a(),E(i,{onClick:B(M=>e.createObject(y),["stop"])},{mate:r(()=>[h(":"+k(e.moduleTitle(e.key)),1)]),default:r(()=>[h(k(y._title)+" ",1)]),_:2},1032,["onClick"]))),256))]),key:"2"}:void 0]),1032,["onMouseout"])]),_:1})}const tt=T(Ye,[["render",et]]),nt=L({name:"nodeTree",props:["object"],components:{YinMenuStructure:tt,YinMenuObject:Re,YinMenu:V,FullscreenFilled:Ee,FullscreenExitFilled:Fe},provide(){return{objectList:z(()=>this.objectList),keyList:z(()=>this.keyList),screen:z(()=>this.screen),lines:z(()=>this.lines)}},data(){return{root:{},objectList:{},keyList:{},screen:{timer:new Date,target:[],targetPlace:null,events:{},refs:[],node:!0},lines:{},lineStartPlace:null,lineClearPlace:null,selectStartPlace:null,selectNowPlace:null,timer:null,space:!1,drag:{},nodeTimer:"",isFullscreen:!1}},methods:{async init(){this.object?this.root=this.object:this.root=this.$yin.me,this.screenCtrl(),await this.makeNode()},refresh(){setTimeout(()=>{this.screen.timer=Date.now()},16)},async makeNode(){this.lines={};for(let e in this.objectList){const t=this.objectList[e];for(let n in t.parents)t.parents[n]&&this.pushLine(e,n,this.keyList[n],t)}await S(),this.screen.timer=Date.now()},pushLine(e,t,n,s){if(e&&n&&s){const u=s.left,o=s.dotY,l=n.right,i=n.dotY,c=(l+u)/2,m=(i+o)/2,C=Math.abs(o-i),D=Math.abs(u-l),p=13,_=13,y=C>_*2?_:C/2,M=i>o?y:-y,g=new this.Ctx(e,t);g.moveTo(l,i),C>_*2?(u<=l+p?(g.lineTo(l+p-y,i),g.bezierCurveTo(l+p,i,l+p,i,l+p,i-M),g.lineTo(l+p,m+M),g.bezierCurveTo(l+p,m,l+p,m,l+p-y,m),g.lineTo(u-p+y,m),g.bezierCurveTo(u-p,m,u-p,m,u-p,m-M),g.lineTo(u-p,o+M),g.bezierCurveTo(u-p,o,u-p,o,u-p+y,o)):(g.lineTo(c-y,i),g.bezierCurveTo(c,i,c,i,c,i-M),g.lineTo(c,o+M),g.bezierCurveTo(c,o,c,o,c+y,o)),g.lineTo(u,o)):D>p*2?(g.lineTo(l+p,i),g.bezierCurveTo(c,i,c,o,u-p,o),g.lineTo(u,o)):g.bezierCurveTo(c,i,c,o,u,o),this.lines[g.title]=g}},Ctx:class{constructor(t,n){P(this,"path","");P(this,"hover",!1);P(this,"title","");P(this,"parent","");P(this,"to","");this.title=t+"-"+n,this.parent=n,this.to=t}moveTo(t,n){this.path+="M "+t+","+n+" "}lineTo(t,n){this.path+="L "+t+","+n+" "}bezierCurveTo(t,n,s,u,o,l){this.path+="C "+t+","+n+" "+s+","+u+" "+o+","+l+" "}},lineStart(e){var t;if(e.target.title){const n=new $(e.target.title);if(n.id&&(e.preventDefault(),!n.key))if(this.lineStartPlace=n,((t=this.screen.target)==null?void 0:t.indexOf(e.target.title))!==-1)for(let s of this.screen.target)this.objectList[s].parents.dotLining=!0;else this.screen.target=[],this.objectList[n].parents.dotLining=!0}},lineToDrag(e){var n;const t=[];if(this.lineStartPlace=e.to,this.lineClearPlace=e.parent,((n=this.screen.target)==null?void 0:n.indexOf(e.to))!==-1)for(let s of this.screen.target)this.objectList[s].parents[e.parent]&&(t.push(s),this.objectList[s].parents.dotLining=!0,this.objectList[s].parents[e.parent]=!1);else this.objectList[e.to].parents.dotLining=!0,this.objectList[e.to].parents[e.parent]=!1;this.screen.target=t},async lineEnd(e){if(e.which===1){const t=this.lineStartPlace,n=this.lineClearPlace,s=this.screen.target,u=this.keyList.dotLining;if(this.clearDotLining(),t)if(e.target.title===n||!u)if(s.length)for(let o of s)this.objectList[o].parents[n]=!0;else this.objectList[t].parents[n]=!0;else{if(n){const o=new $(n),l=await b.get(o),i=l._schemaMix[o.key];if(i.type==="Array")if(s.length)for(let c of s)await l[o.key].remove(new $(c));else await l[o.key].remove(t);else b.structureType.indexOf(i.type)!==-1&&(delete l[o.key],await l._save())}if(t&&e.target.title){const o=new $(e.target.title),l=await b.get(o);if(l._schemaMix[o.key].type==="Array")if(s.length)for(let c of s)await l[o.key].push(c);else await l[o.key].push(t);else l[o.key]=t,await l._save();this.objectList[t]&&(this.objectList[t].parents[e.target.title]=!0)}}}},clearDotLining(){var t;const e=this.lineStartPlace;if(this.lineStartPlace=!1,this.lineClearPlace=!1,e&&((t=this.objectList[e])!=null&&t.parents))if(this.screen.target.length)for(let n of this.screen.target)delete this.objectList[n].parents.dotLining;else delete this.objectList[e].parents.dotLining;delete this.keyList.dotLining,this.selectStartPlace&&this.selectNowPlace===null&&(this.screen.target=[],this.screen.targetPlace=null),this.selectStartPlace=null,this.selectNowPlace=null,delete this.screen.menu},lining(e){if(this.lineStartPlace)e.preventDefault(),delete this.screen.menu,this.keyList.dotLining={left:e.x+this.screen.left,right:e.x+this.screen.left,dotY:e.y+this.screen.top};else if(this.selectStartPlace){e.preventDefault(),delete this.screen.menu,this.screen.target=[],this.selectNowPlace={x:e.x+this.screen.left,y:e.y+this.screen.top};const t={top:Math.min(this.selectStartPlace.y,this.selectNowPlace.y),left:Math.min(this.selectStartPlace.x,this.selectNowPlace.x),bottom:Math.max(this.selectStartPlace.y,this.selectNowPlace.y),right:Math.max(this.selectStartPlace.x,this.selectNowPlace.x)};for(let n in this.objectList){const s=this.objectList[n],u={top:t.top-s.height,bottom:t.bottom+s.height,left:t.left-s.width,right:t.right+s.width};s.top>u.top&&s.bottom<u.bottom&&s.left>u.left&&s.right<u.right&&this.screen.target.push(n)}}},hoverLine(e,t){var n;if(e.parent!=="dotLining"&&!this.selectStartPlace)if(((n=this.screen.target)==null?void 0:n.indexOf(e.to))!==-1)for(let s of this.screen.target)for(let u in this.lines){const o=this.lines[u];o.to===s&&o.parent===e.parent&&(o.hover=!0)}else e.hover=!0},outLine(e,t){for(let n in this.lines){const s=this.lines[n];s.hover=!1}},selectStart(e){this.lineStartPlace||(this.selectStartPlace={x:e.x+this.screen.left,y:e.y+this.screen.top})},screenCtrl(){const e=this.$refs.table;this.screen.left=e.scrollLeft,this.screen.top=e.scrollTop,this.screen.width=e.scrollWidth,this.screen.height=e.scrollHeight},fullscreen(){this.isFullscreen?document.exitFullscreen():this.$refs.table.requestFullscreen(),this.isFullscreen=!this.isFullscreen},makeTarget(e,t){setTimeout(()=>{var n;if(e&&e.length===1&&e[0]!==t[0]){const s=(n=document.getElementById(this.screen.target[0]))==null?void 0:n.getBoundingClientRect();if(s){const u=this.screen,o=this.$refs.table.clientWidth,l=this.$refs.table.clientHeight,i={behavior:"smooth"},c=o>1024?55:13;s.bottom>l&&s.height<l&&(i.top=s.bottom+u.top-l+c),(s.top<0||s.top>l)&&(i.top=s.top+u.top-c),s.left<0&&(i.left=s.left+u.left-c),s.right>o&&(s.width<o?i.left=s.right-o+u.left+c:i.left=s.left+u.left-c),(i.left||i.top)&&this.$refs.table.scroll(i)}}},100)},async menuChange(e,t){if(e){this.removeEvents();const n=new $(e.target),s=t&&new $(t.target);n.key?this.screen.target=[n["module.id"].valueOf(),e.target]:(s&&s.key||!this.screen.target.includes(e.target))&&(this.screen.target=[e.target]),await S(),setTimeout(()=>{const u=this.$refs.menu.$el,o=e.x+u.clientWidth,l=e.y+u.clientHeight,i=this.screen,c=this.$refs.table.clientWidth,m=this.$refs.table.clientHeight,C={behavior:"smooth"};o>i.left+c&&(C.left=o-c+13),l>i.top+m&&(C.top=l-m+13),(C.left||C.top)&&this.$refs.table.scroll(C)},100)}else this.listenEvents()},async refChange(e){if(e){for(let t of e)this.screen.events[t]="ref";e.length&&await navigator.clipboard.writeText(e)}},listenEvents(){document.addEventListener("mouseup",this.lineEnd),document.addEventListener("mousemove",this.lining)},removeEvents(){document.removeEventListener("mouseup",this.lineEnd),document.removeEventListener("mousemove",this.lining)},copy(e){const t=document.getSelection().type!=="Caret";!t&&this.screen.target.length&&(this.screen.refs=this.screen.target,e.preventDefault()),t&&(this.screen.refs=[])},async cut(e){const t=document.getSelection().type!=="Caret";if(!t&&this.screen.target.length){this.screen.refs=this.screen.target;for(let n of this.screen.target){const s=this.objectList[n];s&&s.parent&&(await S(),await(await b.get(s.parent))[s.parent.key].remove(n))}e.preventDefault()}t&&(this.screen.refs=[])},async paste(e){if(this.screen.targetPlace){e.preventDefault();const t=new $(this.screen.targetPlace),n=await b.get(t),s=n._schemaMix[t.key],u=e.clipboardData.getData("text"),o=[];let l=u.split(","),i=this.screen.refs;s.type!=="Array"&&(l.length&&(l.length=1),i.length&&(i=[this.screen.refs[0]]));for(let c of l)try{const m=await b.get(c);o.push(m)}catch{}if(!o.length&&i)for(let c of i)try{const m=await b.get(c);o.push(m)}catch{}if(o.length)if(s.type==="Array")for(let c of o)await n[t.key].push(c);else n[t.key]=o[0],await n._save()}}},mounted(){this.init(),this.listenEvents(),document.addEventListener("copy",this.copy),document.addEventListener("cut",this.cut),document.addEventListener("paste",this.paste)},watch:{objectList:{handler:"makeNode",deep:!0},keyList:{handler:"makeNode",deep:!0},"screen.target":"makeTarget","screen.menu":"menuChange","screen.refs":"refChange"},beforeUnmount(){clearInterval(this.nodeTimer),this.removeEvents(),document.removeEventListener("copy",this.copy),document.removeEventListener("cut",this.cut),document.removeEventListener("paste",this.paste)}});const st={class:"nodeFns"},ot=["x","y","width","height"],it=["onMouseover","onMouseout","onMousedown"],rt=["id","d"],lt=["id","stroke","stroke-width","d"];function ut(e,t,n,s,u,o){var y,M,g;const l=w("YinObject"),i=w("fullscreen-exit-filled"),c=w("fullscreen-filled"),m=w("n-icon"),C=w("n-button"),D=w("n-button-group"),p=w("yin-menu-structure"),_=w("yin-menu-object");return a(),d("div",{class:"nodeTree",ref:"table",onScroll:t[6]||(t[6]=(...f)=>e.screenCtrl&&e.screenCtrl(...f)),onResize:t[7]||(t[7]=(...f)=>e.screenCtrl&&e.screenCtrl(...f)),onClick:t[8]||(t[8]=(...f)=>e.refresh&&e.refresh(...f))},[F("div",{class:"nodes",ref:"nodes",onMousedown:t[0]||(t[0]=B((...f)=>e.lineStart&&e.lineStart(...f),["left"])),onMouseup:t[1]||(t[1]=B(f=>e.screen.menu?e.lineEnd(f):"",["left"]))},[e.root._id?(a(),E(l,{key:0,object:e.root},null,8,["object"])):j("",!0)],544),F("header",st,[v(D,{class:"fns"},{default:r(()=>[v(C,{onClick:e.fullscreen},{default:r(()=>[v(m,{size:"21"},{default:r(()=>[e.isFullscreen?(a(),E(i,{key:0})):(a(),E(c,{key:1}))]),_:1})]),_:1},8,["onClick"]),e.object?j("",!0):(a(),E(C,{key:0},{default:r(()=>[h(k(e.$yin.me._title||"我"),1)]),_:1}))]),_:1})]),(y=e.screen.menu)!=null&&y.type?(a(),E(p,{key:0,ref:"menu",style:H({left:e.screen.menu.x+"px",top:e.screen.menu.y+"px"}),screen:e.screen,objectList:e.objectList},null,8,["style","screen","objectList"])):e.screen.menu?(a(),E(_,{key:1,ref:"menu",style:H({left:e.screen.menu.x+"px",top:e.screen.menu.y+"px"}),screen:e.screen,objectList:e.objectList},null,8,["style","screen","objectList"])):j("",!0),(a(),d("svg",{class:"nodeLines",style:H({minWidth:(M=this.$refs.nodes)==null?void 0:M.scrollWidth,minHeight:(g=this.$refs.nodes)==null?void 0:g.scrollHeight}),onMousedown:t[2]||(t[2]=B((...f)=>e.selectStart&&e.selectStart(...f),["left"])),onMouseup:t[3]||(t[3]=B(f=>e.screen.menu?e.lineEnd(f):"",["left"])),onMousemove:t[4]||(t[4]=f=>e.screen.menu?e.lining(f):""),onContextmenu:t[5]||(t[5]=B((...f)=>e.clearDotLining&&e.clearDotLining(...f),["right"]))},[e.selectNowPlace&&e.selectStartPlace?(a(),d("rect",{key:0,x:Math.min(e.selectStartPlace.x,e.selectNowPlace.x)-1,y:Math.min(e.selectStartPlace.y,e.selectNowPlace.y)-1,width:Math.abs(e.selectStartPlace.x-e.selectNowPlace.x),height:Math.abs(e.selectStartPlace.y-e.selectNowPlace.y),ry:"2",stroke:"#333",fill:"#fafafa","stroke-width":"1"},null,8,ot)):j("",!0),(a(!0),d(N,null,W(e.lines,(f,O)=>(a(),d("g",{ref_for:!0,ref:O,onMouseover:A=>e.hoverLine(f,A),onMouseout:A=>e.outLine(f,A),onMousedown:B(A=>e.lineToDrag(f),["left","stop"])},[F("path",{class:"line",id:O+"-shadow",stroke:"rgba(0,0,0,0)","stroke-width":8,fill:"none",d:f.path},null,8,rt),F("path",{class:"line",id:O,stroke:f.hover?"#333":"#666","stroke-width":f.hover?2:1,fill:"none",d:f.path},null,8,lt)],40,it))),256))],36))],544)}const pt=T(nt,[["render",ut],["__scopeId","data-v-7503ebf3"]]);export{pt as N};
